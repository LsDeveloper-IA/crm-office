// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

/**
 * Models for CRM Office
 * - CNPJ stored as varchar(14) (normalized, only digits)
 * - timestamps use DateTime
 * - raw payloads use Json where appropriate
 */

enum Role {
  ADMIN
  MANAGER
  USER
}

enum CompanySectorStatus {
  NOT_REGISTERED
  PENDING
  REGISTERED
}

enum CertificateStatus {
  VALID
  EXPIRED
  UNKNOWN
}

enum ActivityKind {
  PRIMARY
  SECONDARY
}

/**
 * * USERS **
 */
model User {
  id       Int     @id @default(autoincrement())
  username String  @unique
  name     String?
  password String
  role     Role    @default(USER)
  active   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  companySectors CompanySector[]
  notes          Note[]
  attachments    Attachment[]    @relation("AttachmentUploader")
  certificates   Certificate[]   @relation("CertificateUploader")
  auditLogs      AuditLog[]

  // NEW: forms created by this user
  forms Form[]
}

/**
 * * FORMS (histórico dos formulários internos) **
 */
model Form {
  id            Int      @id @default(autoincrement())
  cnpj          String?  @db.VarChar(14)
  economicGroup String?
  taxRegime     String?
  accountant    String?
  sector        String?
  certificate   Boolean?

  companyCnpj String? @db.VarChar(14) // FK to Company if a company was created from this form

  // NEW: relation back to Company
  createdCompany Company? @relation("FormCompany")

  createdById Int?
  createdBy   User? @relation(fields: [createdById], references: [id])

  createdAt DateTime @default(now())
}

/**
 * * COMPANIES (dados principais + Receita) **
 */
model Company {
  cnpj        String  @id @db.VarChar(14)
  name        String?
  fantasy     String?
  status      String?
  type        String?
  size        String?
  legalNature String?

  publicSpace String?
  number      String?
  district    String?
  city        String?
  state       String?
  zipCode     String? // varchar to preserve leading zeros
  email       String?
  telephone   String?

  opening    DateTime?
  lastUpdate DateTime?

  sourceFormId Int?  @unique
  sourceForm   Form? @relation("FormCompany", fields: [sourceFormId], references: [id])

  rawData Json? // optional: store full API payload if desired

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // relations
  qsas           CompanyQsa[]
  activities     CompanyActivity[]
  companySectors CompanySector[]
  companySystems CompanySystem[]
  contacts       Contact[]
  attachments    Attachment[]
  certificates   Certificate[]
  notes          Note[]
}

/**
 * * QSA (sócios) **
 */
model CompanyQsa {
  id           Int    @id @default(autoincrement())
  companyCnpj  String @db.VarChar(14)
  nome         String
  qualificacao String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  company Company @relation(fields: [companyCnpj], references: [cnpj])

  @@index([companyCnpj])
}

/**
 * * CNAE / atividades **
 */
model CompanyActivity {
  id          Int          @id @default(autoincrement())
  companyCnpj String       @db.VarChar(14)
  cnaeCode    String
  description String?
  kind        ActivityKind

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  company Company @relation(fields: [companyCnpj], references: [cnpj])

  @@index([companyCnpj])
  @@index([cnaeCode])
}

/**
 * * SETORES (catálogo internos) **
 */
model Sector {
  id          Int      @id @default(autoincrement())
  key         String   @unique
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  companySectors CompanySector[]
}

/**
 * * COMPANY_SECTORES (status por setor + responsável) **
 */
model CompanySector {
  id          Int                 @id @default(autoincrement())
  companyCnpj String              @db.VarChar(14)
  sectorId    Int
  status      CompanySectorStatus @default(NOT_REGISTERED)
  ownerId     Int?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  company Company @relation(fields: [companyCnpj], references: [cnpj])
  sector  Sector  @relation(fields: [sectorId], references: [id])
  owner   User?   @relation(fields: [ownerId], references: [id])

  notes Note[]

  @@unique([companyCnpj, sectorId])
  @@index([companyCnpj])
  @@index([sectorId])
}

/**
 * * SYSTEMS (catálogo de sistemas internos) **
 */
model System {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companySystems CompanySystem[]
}

/**
 * * COMPANY_SYSTEMS (status de cadastro em sistemas) **
 */
model CompanySystem {
  id           Int       @id @default(autoincrement())
  companyCnpj  String    @db.VarChar(14)
  systemId     Int
  registered   Boolean   @default(false)
  details      String?
  registeredAt DateTime?

  company Company @relation(fields: [companyCnpj], references: [cnpj])
  system  System  @relation(fields: [systemId], references: [id])

  @@unique([companyCnpj, systemId])
  @@index([companyCnpj])
  @@index([systemId])
}

/**
 * * CONTACTS **
 */
model Contact {
  id        Int     @id @default(autoincrement())
  firstName String
  lastName  String?
  email     String?
  phone     String?
  title     String?

  companyCnpj String @db.VarChar(14)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  company Company @relation(fields: [companyCnpj], references: [cnpj])

  @@index([companyCnpj])
  @@index([email])
}

/**
 * * NOTES **
 */
model Note {
  id              Int     @id @default(autoincrement())
  content         String
  authorId        Int?
  companyCnpj     String? @db.VarChar(14)
  companySectorId Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author        User?          @relation(fields: [authorId], references: [id])
  company       Company?       @relation(fields: [companyCnpj], references: [cnpj])
  companySector CompanySector? @relation(fields: [companySectorId], references: [id])
}

/**
 * * ATTACHMENTS (arquivos vinculados - Google Drive IDs ou S3 keys) **
 */
model Attachment {
  id          Int     @id @default(autoincrement())
  companyCnpj String  @db.VarChar(14)
  driveFileId String? @unique
  url         String?
  filename    String?
  mimetype    String?
  size        Int?

  uploadedBy Int?
  createdAt  DateTime @default(now())

  uploader User?   @relation("AttachmentUploader", fields: [uploadedBy], references: [id])
  company  Company @relation(fields: [companyCnpj], references: [cnpj])

  @@index([companyCnpj])
}

/**
 * * CERTIFICATES (certificados digitais vinculados ao Drive) **
 */
model Certificate {
  id          Int      @id @default(autoincrement())
  companyCnpj String   @db.VarChar(14)
  driveFileId String   @unique
  filename    String?
  mimetype    String?
  size        Int?
  uploadedBy  Int?
  uploadedAt  DateTime @default(now())

  subject       String?
  issuer        String?
  serialNumber  String?
  validFrom     DateTime?
  validTo       DateTime?
  status        CertificateStatus @default(UNKNOWN)
  lastCheckedAt DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  uploader User?   @relation("CertificateUploader", fields: [uploadedBy], references: [id])
  company  Company @relation(fields: [companyCnpj], references: [cnpj])

  @@index([companyCnpj])
  @@index([validTo])
}

/**
 * * AUDIT LOGS **
 */
model AuditLog {
  id        Int      @id @default(autoincrement())
  entity    String
  entityId  Int
  action    String
  payload   Json?
  userId    Int?
  createdAt DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])
}
