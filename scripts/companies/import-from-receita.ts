import "dotenv/config";
import { getOrCreateCompanyByCnpj } from "@/lib/company/company.create";

/**
 * CONFIGURA√á√ïES
 */
const DELAY_MS = 20000; // üëà delay entre chamadas (recomendado 2‚Äì3s)
const MAX_RETRIES = 3;

/**
 * CNPJs (remove duplicados automaticamente)
 */
const CNPJS = Array.from(
  new Set([
    // "12304390000172",
    // "32163918000148",
    // "50655738000165",
    // "11175219000148",
    // "11175219000229",
    // "36111966000143",
    // "04395972000183",
    // "55655800000132",
    // "58507444000106",
    // "11504335000163",
    // "57811207000163",
    // "36470216000168",
    // "26851886000170",
    // "54121275000102",
    // "27772158000136",
    // "27008122000180",
    // "27008122000261",
    // "27008122000342",
    // "58893277000170",
    // "32127100000170",
    // "03910605000108",
    // "01707986000105",
    // "46661527000168",
    // "55899174000120",
    // "10773290000160",
    // "26674814000103",
    // "62143865000164",
    // "09088296000119",
    // "07036370000128",
    // "10662155000147",
    // "04907927000160",
    // "30275386000105",
    // "23406503000167",
    // "00000204000122",
    // "12283107000173",
    // "46571812000198",
    // "57256006000141",
    // "46332986000106",
    // "50713901000107",
    // "69369262000124",
    // "11072882000117",
    // "45682224000169",
    // "54061578000187",
    // "52131017000181",
    // "39148798000159",
    // "04168887000182",
    // "45664856000108",
    // "59882972000108",
    // "54542308000198",
    // "02668300000500",
    // "53313924000104",
    // "62081607000109",
    // "56427044000157",
    // "11116685000152",
    // "42361582000181",
    // "48902263000112",
    // "58474128000177",
    // "55675984000100",
    // "44762786000150",
    // "41881150000139",
    // "34746580000182",
    // "37867482000191",
    // "26761054000163",
    // "06925165000150",
    // "52175930000180",
    // "32604244000170",
    // "44194660002412",
    // "52192781000167",
    // "27842417000158",
    // "27842417000409",
    // "27842417000310",
    // "27842417000905",
    // "27842417000743",
    // "27842417001049",
    // "27842417001120",
    // "47280695000176",
    // "28133640000199",
    // "28133640000270",
    // "46961423000179",
    // "46961423000250",
    // "11523934000124",
    // "61574020000160",
    // "15051628000193",
    // "32787424000134",
    // "50051765000129",
    // "59135284000176",
    // "53961130000157",
    // "23198381000160",
    // "22995817000180",
    // "27939591000113",
    // "07267453000128",
    // "06244797000159",
    // "09529194000191",
    // "08277107000193",
    // "54703753000192",
    // "30296392000149",
    // "06203885000102",
    // "05524900000151",
    // "11768017000100",
    // "01927381000111",
    // "34105390000186",
    // "17128300000153",
    // "08789700000119",
    // "08789700000119",
    // "52898639000130",
    // "51616710000181",
    // "51616710000262",
    // "45316600000100",
    // "00000103000151",
    // "05092558000168",
    // "10421042000150",
    // "33753398000196",
    // "36390228000182",
    // "20222621000127",
    // "02142491000130",
    // "47309287000108",
    // "21871806000125",
    // "23633380000105",
    // "23633380000288",
    // "53912477000100",
    // "18241874000104",
    // "31956461000166",
    // "11008634000107",
    // "11008634000298",
    // "11008634000450",
    // "11008634000530",
    // "11008634000611",
    // "11008634000700",
    // "11008634000883",
    // "11008634000964",
    // "11008634001006",
    // "53998299000181",
    // "33854927000148",
    // "12975412000126",
    // "27796696000160",
    // "23312865000199",
    // "03614160000119",
    // "50940525000185",
    // "53433241000190",
    // "46132269000122",
    // "36595198000140",
    // "28954979000156",
    // "00451700000100",
    // "25308291000100",
    // "59089481000104",
    // "37549959000190",
    // "39727753000139",
    // "12660428000140",
    // "55479491000197",
    // "43597634000186",
    // "63557474000159",
    // "63557474000310",
    // "63557474000582",
    // "63557474000400",
    // "55045495000167",
    // "51480035000106",
    // "44995186000131",
    // "31783778000148",
    // "28337064000100",
    // "41751852000106",
    // "35561114000195",
    // "55630838000150",
    // "00275851000147",
    // "00275851000228",
    // "00275851000490",
    // "39429721000157",
    // "59667118000110",
    // "55925727000171",
    // "46382017000151",
    // "27846954000176",
    // "32469275000165",
    // "26545367000184",
    // "54948428000190",
    // "61882607000137",
    // "53141968000102",
    // "61815249000140",
    // "47065251000118",
    // "55033065000125",
    // "20612090000189",
    // "00169671000180",
    // "59676571000193",
    // "46873526000187",
    // "04014228000191",
    // "42931053000176",
    // "29237659000148",
    // "25406071000110",
    // "28446022000107",
    // "57361889000150",
    // "62045772000105",
    // "33566940000100",
    // "31443725000188",
    // "31449429000194",
    // "47843183000170",
    // "49545422000131",
    // "28378369000151",
    // "53656131000198",
    // "56348020000102",
    // "31578226000106",
    // "36027303000145",
    // "12708603000121",
    // "54771087000120",
    // "33625376000140",
    // "16729323000150",
    // "11569286000147",
    // "47305819000120",
    // "62219616000105",
    // "34456110000184",
    // "60399655000106",
    // "56957395000170",
    // "12301909000169",
    // "24450328000178",
    // "57932058000190",
    // "14943089000134",
    // "35932865000170",
    // "45823104000134",
    // "31160306000139",
    // "38223980000164",
    // "34457857000157",
    // "09664047000124",
    // "03190660000170",
    // "31534109000132",
    // "46245854000139",
    // "58695646000110",
    // "43472120000102",
    // "16804935000160",
    // "56428085000168",
    // "33979490000179",
    // "42384005000105",
    // "27634832000116",
    // "19794018000130",
    // "18921941000123",
    // "36575725000155",
    // "36575725000155",
    // "18067133000140",
    // "06349204000119",
    // "54042219000182",
    // "22094019000187",
    // "30391540000104",
    // "17461689000154",
    // "47305803000118",
    // "44269438000145",
    // "58646424000108",
    // "26379686000248",
    // "26379686000167",
    // "36558891000143",
    // "52666471000137",
    // "60636025000108",
    // "25361374000163",
    // "09129812000106",
    // "27542847000154",
    // "28551795000145",
    // "06323147000107",
    // "12201339000135",
    // "28507422000177",
    // "02361512000109",
    // "55807393000131",
    // "18519713000121",
    // "44673165000108",
    // "58373794000119",
    // "32219500000105",
    // "61898692000121",
    // "55535391000130",
    // "13017172000110",
    // "13017172000209",
    // "13017172000381",
    // "04626218000107",
    // "53489253000137",
    // "14507786000142",
    // "49476603000153",
    // "56968580000160",
    // "41726250000190",
    // "37186465000199",
    // "55064308000192",
    // "26522187000187",
    // "46889756000134",
    // "23468321000110",
    // "43476240000170",
    // "58361418000104",
    // "11450901000100",
    // "55234245000175",
    // "29212732000127",
    // "38183341000112",
    // "36437892000130",
    // "26620011000168",
    // "00561725000159",
    // "33120099000114",
    // "10241360000139",
    // "10470850000107",
    // "10470850000298",
    // "10470850000379",
    // "10470850000450",
    // "10470850000530",
    // "10470850000611",
    // "10470850000700",
    // "10470850000883",
    // "10470850001189",
    // "10470850001421",
    // "10470850001502",
    // "32031032000140",
    // "56934972000108",
    // "23662645000195",
    // "46878838000183",
    // "02179944000101",
    // "47712063000134",
    // "47712063000215",
    // "26827331000193",
    // "03915936000130",
    // "34969598000143",
    // "55975471000107",
    // "01884066000154",
    // "10488345000190",
    // "05468044000164",
    // "05468044000245",
    // "05468044000407",
    // "44207487000153",
    // "39401367000152",
    // "49231592000141",
    // "45057446000190",
    // "52853209000100",
    // "33038861000118",
    // "50168447000142",
    // "20948559000155",
    // "04565976000162",
    // "19753761000142",
    // "23570351000133",
    // "54615534000151",
    // "08950624000181",
    // "05618648000140",
    // "47333767000104",
    // "58926678000180",
    // "36458458000136",
    // "47338372000196",
    // "52401358000120",
    // "07395422000152",
    // "45365874000180",
    // "40106124000170",
    // "43954186000120",
    // "21271720000161",
    // "13212979000103",
    // "13212979000294",
    // "13128730000114",
    // "42443568000127",
    // "33039005000187",
    // "29633819000178",
    // "29633819000259",
    // "41110718000118",
    // "40796681000160",
    // "22808342000175",
    // "49927160000170",
    // "29058360000126",
    // "53831470000163",
    // "01208014000168",
    // "34128162000121",
    // "05811462000102",
    // "32105956000144",
    // "44829652000109",
    // "53217379000152",
    // "12319284000162",
    // "47253558000142",
    // "09028577000186",
    // "45903435000184",
    // "14681925000150",
    // "22715950000135",
    // "60529451000142",
    // "52202084000140",
    // "38626988000171",
    // "23459944000127",
    // "51440145000144",
    // "50208515000150",
    // "30130642000176",
    // "41949858000184",
    // "03517108000144",
    // "03517108000225",
    // "35816844000190",
    // "17447150000140",
    // "14800941000114",
    // "34762926000136",
    // "34762926000217",
    // "11868194000168",
    // "02653810000172",
    // "42420230000150",
    // "28009440000129",
    // "05230004000180",
    // "05230004000260",
    // "23253587000146",
    // "41034740000126",
    // "07429664000110",
    // "23048728000199",
    // "24613620000164",
    // "49262655000127",
    // "54038437000143",
    // "60391740000128",
    // "09180799000110",
    // "36485519000154",
    // "02177099000127",
    // "16745090000180",
    // "46256526000138",
    // "23407798000196",
    // "60807956000121",
    // "34177866000194",
    // "29058398000107",
    // "17220091000173",
    // "45894305000122",
    // "41661985000183",
    // "14424839000161",
    // "00561708000111",
    // "59645224000101",
    // "16655500000100",
    // "34385225000125",
    // "08271390000146",
    // "29338306000134",
    // "43395890000190",
    // "35158085000115",
    // "34414954000162",
    // "11612134000180",
    // "61064855000170",
    // "18083210000156",
    // "47951740000177",
    // "07497216000153",
    // "04057765000119",
    // "11349234000165",
    // "50373259000156",
    // "47673225000172",
    // "41035256000111",
    // "13351343000142",
    // "24668316000114",
    // "53375265000130",
    // "08749429000198",
    // "00148722000198",
    // "59577542000174",
    // "61435315000156",
    // "30879596000102",
    // "10510265000193",
    // "10510265000274",
    // "33654284000199",
    // "33654284000270",
    // "39341220000114",
    // "50883373000126",
    // "31006215000143",
    // "50524851000101",
    // "50524851000292",
    // "04883786000193",
    // "58295953000104",
    // "60806505000170",
    // "47973301000165",
    // "29910127000120",
    // "55327793000140",
    // "31196191000132",
    // "00797635000161",
    // "58263816000198",
    // "51899408000188",
    // "19323025000154",
    // "43434991000123",
    // "32921360000112",
    // "04944715000153",
    // "23709793000118",
    // "21761943000107",
    // "05896883000183",
    // "29449938000175",
    // "56080670000110",
    // "15372724000133",
    // "15372724000214",
    // "44509831000169",
    // "44565308000150",
    // "14166369000183",
    // "08187994000109",
    // "23842538000149",
    // "59446949000162",
    // "34640062000180",
    // "01103427000188",
    // "01103427000269",
    // "01103427000340",
    // "01103427000420",
    // "01103427000501",
    // "03180905000189",
    // "20777093000172",
    // "41465329000105",
    // "58531221000176",
    // "19138350000147",
    // "02943170000135",
    // "07966762000196",
    // "49799297000196",
    // "20357868000150",
    // "50322417000149",
    // "10954861000162",
    // "10954861000243",
    // "50899331000183",
    // "43080614000133",
    // "10787411000122",
    // "07925585000108",
    // "01463705000108",
    // "10994722000162",
    // "14916727000128",
    // "57117427000191",
    // "35078829000191",
    // "36146811000142",
    // "54917763000120",
    // "56085225000142",
    // "10734167000130",
    // "09513517000159",
    // "36668478000131",
    // "08302719000199",
    // "29865994000190",
    // "48860094000103",
    "62816802000121"
  ])
);

/**
 * Utilit√°rio de delay
 */
function sleep(ms: number) {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

/**
 * Retry simples com backoff
 */
async function withRetry<T>(
  fn: () => Promise<T>,
  retries = MAX_RETRIES
): Promise<T> {
  try {
    return await fn();
  } catch (err) {
    if (retries <= 0) throw err;

    console.warn(
      `‚ö†Ô∏è Erro tempor√°rio. Tentando novamente em ${DELAY_MS}ms... (${retries} restantes)`
    );

    await sleep(DELAY_MS);
    return withRetry(fn, retries - 1);
  }
}

async function run() {
  console.log("üöÄ Iniciando importa√ß√£o de empresas");
  console.log(`üì¶ Total de CNPJs: ${CNPJS.length}`);
  console.log(`‚è±Ô∏è Delay entre chamadas: ${DELAY_MS}ms\n`);

  let success = 0;
  let failed = 0;

  for (let i = 0; i < CNPJS.length; i++) {
    const rawCnpj = CNPJS[i];
    const cnpj = rawCnpj.replace(/\D/g, "");

    console.log(`(${i + 1}/${CNPJS.length}) üîé ${cnpj}`);

    try {
      const company = await withRetry(() =>
        getOrCreateCompanyByCnpj(cnpj)
      );

      console.log(
        `   ‚úÖ ${company.name} importada com sucesso`
      );
      success++;
    } catch (err: any) {
      console.error(
        `   ‚ùå Falha ao importar ${cnpj}:`,
        err?.message ?? err
      );
      failed++;
    }

    // delay entre empresas (mesmo se der erro)
    await sleep(DELAY_MS);
  }

  console.log("\nüèÅ Importa√ß√£o finalizada");
  console.log(`‚úÖ Sucesso: ${success}`);
  console.log(`‚ùå Falhas: ${failed}`);

  process.exit(0);
}

run();